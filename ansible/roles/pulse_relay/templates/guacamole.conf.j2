<Location /guacamole-{{ XMPP_DOMAIN }}/>
{% if LOADBALANCER_FQDN is defined and LOADBALANCER_FQDN %}
    SetEnvIf Referer "^https?://{{ LOADBALANCER_FQDN }}/" GUACAMOLE_ALLOWED
{% else %}
    SetEnvIf Referer "^https?://{{ PULSEMAIN_FQDN }}/" GUACAMOLE_ALLOWED
{% endif %}
    Order Deny,Allow
    Deny from all
    Allow from env=GUACAMOLE_ALLOWED
    ProxyPass http://{{ SERVER_FQDN }}:8081/guacamole/ max=20 flushpackets=on
    ProxyPassReverse http://{{ SERVER_FQDN }}:8081/guacamole/
    ProxyPassReverseCookiePath /guacamole/ /guacamole-{{ XMPP_DOMAIN}}/
</Location>
<Location /guacamole-{{ XMPP_DOMAIN }}/websocket-tunnel>
{% if LOADBALANCER_FQDN is defined and LOADBALANCER_FQDN %}
    SetEnvIf Referer "^https?://{{ LOADBALANCER_FQDN }}/" GUACAMOLE_ALLOWED
{% else %}
    SetEnvIf Referer "^https?://{{ PULSEMAIN_FQDN }}/" GUACAMOLE_ALLOWED
{% endif %}
    Order Deny,Allow
    Deny from all
    Allow from env=GUACAMOLE_ALLOWED
    ProxyPass ws://{{ SERVER_FQDN }}:8081/guacamole/websocket-tunnel
    ProxyPassReverse ws://{{ SERVER_FQDN }}:8081/guacamole/websocket-tunnel
    ProxyPassReverseCookiePath /guacamole/ /guacamole-{{XMPP_DOMAIN }}/
</Location>
SetEnvIf Request_URI "^/guacamole/tunnel" dontlog
