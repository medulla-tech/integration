#!/bin/bash
#
# (c) 2022 Siveo, http://siveo.net
#
# This file is part of Medulla
#
# Medulla is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# Medulla is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Medulla; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
# MA 02110-1301, USA.

# PARAMETERS TO BE SET
DL_URL={{ DL_BASEURL }}/updates_protected
SHARE_NAME=winupdatesmajor
DEST=/var/lib/pulse2/packages/sharing/${SHARE_NAME}
COMMAND='powershell -NoProfile -ExecutionPolicy Bypass -File ".\update_iso.ps1"'

PACKAGE_UUID=$(uuidgen)
PACKAGE_DATE=$(date +'%F %X')

DBHOST=$(crudini --get /etc/mmc/plugins/xmppmaster.ini.local database dbhost 2> /dev/null || echo localhost)
DBPORT=$(crudini --get /etc/mmc/plugins/xmppmaster.ini.local database dbport 2> /dev/null || echo 3306)
DBUSER=$(crudini --get /etc/mmc/plugins/xmppmaster.ini.local database dbuser 2> /dev/null || echo mmc)
DBPASS=$(crudini --get /etc/mmc/plugins/xmppmaster.ini.local database dbpasswd)
KEYAES32=$(crudini --get /etc/mmc/plugins/xmppmaster.ini.local defaultconnection keyAES32)


colored_echo() {
    # Output colored lines to shell
    local COLOR=$1;
    if ! [[ $COLOR =~ '^[0-9]$' ]] ; then
        case $(echo $COLOR | tr '[:upper:]' '[:lower:]') in
            black) COLOR=0 ;;
            red) COLOR=1 ;;
            green) COLOR=2 ;;
            yellow) COLOR=3 ;;
            blue) COLOR=4 ;;
            magenta) COLOR=5 ;;
            cyan) COLOR=6 ;;
            white|*) COLOR=7 ;; # white or invalid color
        esac
    fi
    tput setaf $COLOR;
    echo "${@:2}";
    tput sgr0;
}


display_usage() {
    #
    # Display usage message
    #
    echo -e "\nUsage:\n$0 --version [--force]\n"
    echo -e "arguments:"
    echo -e "\t--version=<Windows complete version> eg. Win11_24H2_French_x64"
    echo -e "\t[--force]"
    exit 0
}


check_arguments() {
    #
    # Make sure the options passed are valid
    #
    ARGS="$@"
    for i in "$@"; do
        case $i in
            --version*)
                VERSION="${i#*=}"
                shift
                ;;
            --force*)
                FORCE=1
                shift
                ;;
            *)
                # unknown option
                display_usage
                ;;
        esac
    done
}

run_checks() {
    #
    # Check that all required parameters are set
    #
    if [[ ${DL_URL} == '' ]]; then
        colored_echo red "$(date +\[%F\ %X\]) DL_URL parameter is not set. Please set it"
        exit 1
    fi

    if [[ ${VERSION} == '' ]]; then
        colored_echo red "$(date +\[%F\ %X\]) This script needs to be called with the version as argument. eg: --version=Win11_24H2_French_x64"
        exit 1
    fi
}

check_package_exists() {
    #
    # Check if package already exists in the database
    #
    local result=$(mysql -h ${DBHOST} -P ${DBPORT} -u${DBUSER} -p${DBPASS} pkgs \
        -se "SELECT uuid FROM packages WHERE label='${VERSION}' LIMIT 1")
    
    if [[ -n "${result}" ]]; then
        echo "${result}" # Return the uuid
        return 0
    else
        echo "false" # Return false if no record is found
        return 1
    fi
}

download_ps1_script() {
    #
    # Create powershell script to update the system
    #
    colored_echo blue "Downloading powershell script to update the system..."
    curl --silent -C - -o ${DEST}/${PACKAGE_UUID}/update_iso.ps1 ${DL_URL}/${VERSION%%_*}/update_iso.ps1?token=${KEYAES32}
}

generate_package() {
    #
    # Create package file
    #
    colored_echo blue "Generating package..."
    cat <<EOF > ${DEST}/${PACKAGE_UUID}/xmppdeploy.json
{
        "info": {
            "urlpath" : "",
            "creator": "automate_medulla",
            "creation_date": "$PACKAGE_DATE",
            "licenses": "1.0",
            "gotoreturncode": "3010",
            "gotolabel": "REBOOTREQUIRED",
            "packageUuid": "$PACKAGE_UUID",
            "spooling": "ordinary",
            "limit_rate_ko": "",
            "version": "1.0",
            "editor": "automate_medulla",
            "metagenerator": "expert",
            "targetrestart": "MA",
            "inventory": "False",
            "localisation_server": "$SHARE_NAME",
            "typescript": "Batch",
            "description": "Major update to $VERSION",
            "previous_localisation_server": "$SHARE_NAME",
            "Dependency": [],
            "name": "$VERSION",
            "url": "",
            "edition_date": "$PACKAGE_DATE",
            "transferfile": true,
            "methodetransfert": "pushrsync",
            "software": "templated",
            "type_section" : "update"
        },
        "win": {
            "sequence": [
                {
                    "action": "action_section_update", 
                    "step": 0, 
                    "actionlabel": "upd_70a70cc9"
                }, 
                {
                    "command": "$(echo $COMMAND | base64 -w0)",
                    "30@lastlines": "30@lastlines",
                    "actionlabel": "02d57e96",
                    "codereturn": "",
                    "step": 1,
                    "error": 6,
                    "action": "actionprocessscript",
                    "timeout": "3600",
                    "gotoreturncode@3010": "REBOOTREQUIRED"
                },
                {
                    "action": "actionwaitandgoto",
                    "step": 2,
                    "codereturn": "",
                    "actionlabel": "wait_cc66c870",
                    "waiting": "1",
                    "goto": "END_SUCCESS"
                },
                {
                    "step": 3,
                    "action": "action_comment",
                    "actionlabel": "REBOOTREQUIRED",
                    "comment": "The update has been installed but a reboot is required to apply it."
                },
                {
                    "action": "action_notification",
                    "step": 4,
                    "codereturn": "",
                    "actionlabel": "notif_ee9943f2",
                    "titlemessage": "V2luZG93cyBVcGRhdGUgLSBSZWJvb3Q=",
                    "sizeheader": "15",
                    "message": "QW4gdXBkYXRlIGhhcyBiZWVuIGluc3RhbGxlZCBvbiB5b3VyIGNvbXB1dGVyIGJ5IE1lZHVsbGEuIFBsZWFzZSByZWJvb3Qgd2hlbiBwb3NzaWJsZSB0byBhcHBseSB0aGUgdXBkYXRlLg0KDQpVbmUgbWlzZSDDoCBqb3VyIGEgw6l0w6kgaW5zdGFsbMOpZSBzdXIgdm90cmUgb3JkaW5hdGV1ciBwYXIgTWVkdWxsYS4gUGVuc2V6IMOgIHJlZMOpbWFycmVyIHF1YW5kIGMnZXN0IHBvc3NpYmxlIGFmaW4gcXVlIGxhIG1pc2Ugw6Agam91ciBzb2l0IGFwcGxpcXXDqWUu",
                    "sizemessage": "10",
                    "textbuttonyes": "OK",
                    "timeout": "800"
                },
                {
                    "action": "actionsuccescompletedend",
                    "step": 5,
                    "actionlabel": "END_SUCCESS",
                    "clear": "False",
                    "inventory": "noforced"
                },
                {
                    "action": "actionerrorcompletedend",
                    "step": 6,
                    "actionlabel": "END_ERROR"
                }
            ]
        },
        "metaparameter": {
            "win": {
                "label": {
                    "upd_70a70cc9": 0,
                    "02d57e96": 1,
                    "wait_cc66c870": 2,
                    "REBOOTREQUIRED": 3,
                    "notif_ee9943f2": 4,    
                    "END_SUCCESS": 5,
                    "END_ERROR": 6
                }
            },
            "os": [
                "win"
            ]
        }
    }
}
EOF
    
    cat <<EOF > ${DEST}/${PACKAGE_UUID}/conf.json
{
            "urlpath" : "",
            "localisation_server": "$SHARE_NAME",
            "sub_packages": [],
            "metagenerator": "manual",
            "description": "Major update to $VERSION",
            "creator": "root",
            "edition_date": "$PACKAGE_DATE",
            "previous_localisation_server": "$SHARE_NAME",
            "entity_id": "0",
            "creation_date": "$PACKAGE_DATE",
            "inventory": {
                "associateinventory": "0",
                "licenses": "",
                "queries": {
                    "Qsoftware": "",
                    "Qvendor": "",
                    "boolcnd": "",
                    "Qversion": ""
                }
            },
            "version": "1.0",
            "reboot": 0,
            "editor": "",
            "targetos": "win",
            "commands": {
                "postCommandSuccess": {
                    "command": "",
                    "name": ""
                },
                "command": {
                    "command": "",
                    "name": ""
                },
                "postCommandFailure": {
                    "command": "",
                    "name": ""
                },
                "installInit": {
                    "command": "",
                    "name": ""
                },
                "preCommand": {
                    "command": "",
                    "name": ""
                }
            },
            "id": "$PACKAGE_UUID",
            "name": "$VERSION"
        }
EOF

}

download_iso() {
    #
    # Download ISO file
    #
    colored_echo blue "Downloading ISO file ${DL_URL}/${VERSION%%_*}/${VERSION}.iso to ${DEST}/${PACKAGE_UUID}/${VERSION}.iso..."
    curl --silent -C - -o ${DEST}/${PACKAGE_UUID}/${VERSION}.iso ${DL_URL}/${VERSION%%_*}/${VERSION}.iso?token=${KEYAES32}
}

create_package_record() {
    #
    # Create package record in the database
    #
    colored_echo blue "$(date +\[%F\ %X\]) Creating package record in the database..."
    /usr/sbin/pulse2-generation_package.py -H${DBHOST} -P${DBPORT} -u${DBUSER} -p${DBPASS} -r -l -g
}



colored_echo blue "$(date +\[%F\ %X\]) ##### Starting $(basename $0)"
check_arguments $@
run_checks
old_package_uuid=$(check_package_exists)
if [[ "${old_package_uuid}" != "false" ]]; then
    if [[ ${FORCE} == 1 ]]; then
        colored_echo blue "$(date +\[%F\ %X\]) Package already exists with UUID: ${old_package_uuid} but forcing package re-creation..."
        rm -rf ${DEST}/${old_package_uuid}
        colored_echo blue "$(date +\[%F\ %X\]) Creating new package with UUID ${PACKAGE_UUID}..."
        mkdir -p ${DEST}/${PACKAGE_UUID}
    else
        colored_echo red "$(date +\[%F\ %X\]) Package already exists with UUID: ${old_package_uuid}"
        exit 1
    fi
else
    colored_echo blue "$(date +\[%F\ %X\]) Creating new package with UUID ${PACKAGE_UUID}..."
    mkdir -p ${DEST}/${PACKAGE_UUID}
fi
download_ps1_script
generate_package
download_iso
create_package_record
colored_echo green "$(date +\[%F\ %X\]) ##### Finished $(basename $0)"


